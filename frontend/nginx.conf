server {
  listen 80;
  server_name _;
  root  /usr/share/nginx/html;
  index index.html;

  # Health opcional
  location = /health { return 200 "ok"; add_header Content-Type text/plain; }

  # ============ SPA ConsultasSV bajo /consultas ============
  # redirección si entran sin trailing slash
  location = /consultas { return 301 /consultas/; }

  # fallback de SPA de Consultas
  location ^~ /consultas/ {
    try_files $uri $uri/ /consultas/index.html;
  }

  # ============ PROXIES ============

  # 1) ConsultasSV - ruta natural (el backend expone /api/consultas/…)
  #    Mantiene el path tal cual (no reescribe).
  location ^~ /api/consultas/ {
    proxy_pass http://consultas_api:3000;   # ← sin path al final
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header Access-Control-Allow-Credentials "true" always;
  }

  # 1.b) ConsultasSV - alias compatible: /api-consultas/... -> /api/...
  location ^~ /api-consultas/ {
    rewrite ^/api-consultas/(.*)$ /api/$1 break;
    proxy_pass http://consultas_api:3000;   # ← sin path al final
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header Access-Control-Allow-Credentials "true" always;
  }

  # 2) API principal (Nest de ingreso) – todo lo de /api/ excepto /api/consultas/
  location ^~ /api/ {
    proxy_pass http://sv_api:3000;         # ← sin path al final (preserva /api/health, /api/auth/login, etc.)
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header Access-Control-Allow-Credentials "true" always;
  }

  # ============ SPA principal ============
  location / {
    try_files $uri /index.html;
  }

  client_max_body_size 20m;
}
